define(function(){function a(a){var b=a.getElementsByTagName("broadcast")[0];if(b){var c=b.getAttribute("on");if(c)return c}return g.defaultChannel}function b(a,b){var c=b.getElementsByTagName("listen");return c=Array.prototype.slice.call(c),0===c.length?[{listener:a.defaultListener,channel:g.defaultChannel}]:c=c.map(function(a){var b=a.getAttribute("on"),c=a.getAttribute("for");return{listener:c,channel:b?b:g.defaultChannel}})}function c(b,c){b.broadcastChannel=a(c),b.setBroadcastChannel=function(a){b.broadcastChannel=a}}function d(a,c){a.subscriptions=b(a,c),a.setSubscription=function(b,c){var d=!0;a.subscriptions.forEach(function(a){a.listener===c&&(a.channel=b,d=!1)}),d&&a.subscriptions.push({listener:c,channel:b})},a.removeSubscription=function(a,b){e.subscriptions=e.subscriptions.filter(function(c){return!(c.channel===a&&c.listener===b)})}}var f=function(a){return"flathead:"+a},g=function(a,b){Object.keys(b).filter(function(a){return-1===g._reserved.indexOf(a)}).forEach(function(c){var d=b[c];"function"==typeof d&&(a[c]=d)});var c=b.defaultListener;c||(c=Object.keys(b.listeners)[0]),a.defaultListener=c,a.subscriptionListeners=[],Object.keys(b.listeners).forEach(function(c){var d=b.listeners[c],e=typeof d;if("function"!==e)throw'Listener "'+c+'" is not a function.';a[c]=d,a.subscriptionListeners.push(c)}),a.emit=function(b){var c=new CustomEvent(f(a.broadcastChannel),{bubbles:!0,detail:b});a.dispatchEvent(c)},a.init=function(){b.init&&b.init.call(a)},g._plugins.constructor.forEach(function(c){c(a,b)})};return g._reserved=["init","listeners","defaultListener"],g.reserveKeyword=function(a){g._reserved.push(a)},g._plugins={constructor:[]},g.registerCeciPlugin=function(a,b){g._plugins[a].push(b)},g.defaultChannel="blue",g._components={},g.convertElement=function(a){var b=g._components[a.localName],e=a.cloneNode(!0);a._innerHTML=a.innerHTML,a._innerText=a.innerText,b.template&&(a.innerHTML=b.template.innerHTML),b.contructor.call(a,b.initParams|{}),c(a,e),d(a,e),a.subscriptions.forEach(function(b){console.log("Adding event listener for",a.id+"."+b.listener+"(<data>)","on",b.channel),document.addEventListener(f(b.channel),function(c){return c.target!==a&&a[b.listener](c.detail,b.channel),!0})}),a.init()},g.processComponent=function(a){var b=a.getAttribute("name"),c=a.querySelector("template"),d=a.querySelector('script[type="text/ceci"]');try{var e=new Function("Ceci","return function() {"+d.innerHTML+"}")}catch(f){throw"SyntaxError"===f.name?(f.message+=' in definition of component "'+b+'".',f):f}var h=e(g);g._components[b]={template:c,contructor:h};var i=document.querySelectorAll(b);Array.prototype.forEach.call(i,function(a){g.convertElement(a)})},g.load=function(a){function b(a){var b=document.querySelectorAll("element");b=Array.prototype.slice.call(b),b.forEach(g.processComponent),a&&a(g._components)}var c=document.querySelectorAll('link[rel=component][type="text/ceci"]');if(c.length){var d=c.length;Array.prototype.forEach.call(c,function(c){var e=new XMLHttpRequest,f=c.getAttribute("href");e.open("GET",f,!0),e.onload=function(){var c=document.createElement("div");c.innerHTML=e.response,document.body.firstChild?document.body.insertBefore(c,document.body.firstChild):document.body.appendChild(c),0===--d&&b(a)},e.send(null)})}else b(a)},g});