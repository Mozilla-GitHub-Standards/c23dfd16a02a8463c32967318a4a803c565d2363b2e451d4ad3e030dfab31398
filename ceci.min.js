define(function(){function a(a){var b=a.getElementsByTagName("broadcast")[0];if(b){var c=b.getAttribute("on");if(c)return c}return d.defaultChannel}function b(a){var b=a.getElementsByTagName("listen");return b=Array.prototype.slice.call(b),0===b.length?[]:b=b.map(function(a){var b=a.getAttribute("on"),c=a.getAttribute("for");return{listener:c,channel:b?b:d.defaultChannel}})}var c=function(a){return"flathead:"+a},d=function(a,b){var d=["init","listeners","defaultListener"];Object.keys(b).filter(function(a){return-1===d.indexOf(a)}).forEach(function(c){var d=b[c];"function"==typeof d&&(a[c]=d)}),Object.keys(b.listeners).forEach(function(c){var d=b.listeners[c],e=typeof d;if("function"!==e)throw'Listener "'+c+'" is not a function.';a[c]=d}),a.emit=function(b){var d=document.createEvent("CustomEvent");d.initCustomEvent(c(a.broadcastChannel),{bubbles:!0}),d.data=b,a.dispatchEvent(d),console.log(a.id+" -> "+a.broadcastChannel)},a.init=function(){b.init&&b.init.call(a)}};return d.reserved=["init","listeners","defaultListener","initParams"],d.defaultChannel="blue",d._components={},d.convertElement=function(e){var f=d._components[e.localName];e.broadcastChannel=a(e),e.subscriptions=b(e),e._innerHTML=e.innerHTML,e._innerText=e.innerText,f.template&&(e.innerHTML=f.template.innerHTML),f.contructor.call(e,f.initParams|{}),e.subscriptions.forEach(function(a){console.log("Adding event listener for",e.id+"."+a.listener+"(<data>)","on",a.channel),document.addEventListener(c(a.channel),function(b){return b.target!==e&&(console.log(e.id+" <- "+a.channel),e[a.listener](b.data,a.channel)),!0})}),e.init()},d.processComponent=function(a){var b=a.getAttribute("name"),c=a.querySelector("template"),e=a.querySelector('script[type="text/ceci"]');try{var f=new Function("Ceci","return function() {"+e.innerHTML+"}")}catch(g){throw"SyntaxError"===g.name?(g.message+=' in definition of component "'+b+'".',g):g}var h=f(d);d._components[b]={template:c,contructor:h};var i=document.querySelectorAll(b);Array.prototype.forEach.call(i,function(a){d.convertElement(a)})},Runner=function(a){function b(){var a=document.querySelectorAll("element");a=Array.prototype.slice.call(a),a.forEach(d.processComponent)}var c=document.querySelectorAll('link[rel=component][type="text/ceci"]');if(c.length){var e=c.length;Array.prototype.forEach.call(c,function(c){var d=new XMLHttpRequest,f=c.getAttribute("href");d.open("GET",f,!0),d.onload=function(){var c=document.createElement("div");c.innerHTML=d.response,document.body.firstChild?document.body.insertBefore(c,document.body.firstChild):document.body.appendChild(c),0===--e&&(b(),a&&a())},d.send(null)})}else b()}});