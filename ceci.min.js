define(function(){function a(a){var b=a.getElementsByTagName("broadcast")[0];if(b){var c=b.getAttribute("on");if(c)return c}return f._defaultBroadcastChannel}function b(a,b){var c=b.getElementsByTagName("listen");return c=Array.prototype.slice.call(c),0===c.length?a.defaultListener?[{listener:a.defaultListener,channel:f._defaultListeningChannel}]:[]:c=c.map(function(a){var b=a.getAttribute("on"),c=a.getAttribute("for");return{listener:c,channel:b}})}function c(b,c){b.broadcastChannel=a(c),b.setBroadcastChannel=function(a){b.broadcastChannel=a}}function d(a,c){a.subscriptions=b(a,c);var d=function(a,b,c){return function(d){d.target!==a&&(console.log(a,b,c),a[c](d.detail,b))}};a.setSubscription=function(b,c){var e,g=!0;a.subscriptions.forEach(function(h){h.listener===c&&(e=a[c].listeningFunction,e&&(console.log("removing "+h.channel+"/"+c+" pair"),document.removeEventListener(h.channel,e)),h.channel=b,b!==f._emptyChannel?(e=d(a,h.channel,h.listener),console.log("adding "+h.channel+"/"+c+" pair"),document.addEventListener(h.channel,e)):e=!1,a[c].listeningFunction=e,g=!1)}),g&&(e=d(a,b,c),a[c].listeningFunction=e,console.log("adding "+b+"/"+c+" pair"),document.addEventListener(b,e),a.subscriptions.push({listener:c,channel:b}))},a.removeSubscription=function(a,b){var c=function(c){return!(c.channel===a&&c.listener===b)};a&&!b&&(b=a,c=function(a){return a.listener!==b}),e.subscriptions=e.subscriptions.filter(c)},a.subscriptions.forEach(function(b){var c=d(a,b.channel,b.listener);a[b.listener].listeningFunction=c,document.addEventListener(b.channel,c)})}var f=function(a,b){Object.keys(b).filter(function(a){return-1===f._reserved.indexOf(a)}).forEach(function(c){var d=b[c];"function"==typeof d&&(a[c]=d)}),a.defaultListener=b.defaultListener,a.subscriptionListeners=[],Object.keys(b.listeners).forEach(function(c){var d=b.listeners[c],e=typeof d;if("function"!==e)throw'Listener "'+c+'" is not a function.';a[c]=d,a.subscriptionListeners.push(c)}),a.emit=function(b){if(a.broadcastChannel!==f._emptyChannel){var c=new CustomEvent(a.broadcastChannel,{bubbles:!0,detail:b});a.dispatchEvent(c),console.log(a.id+" -> "+a.broadcastChannel)}},a.init=function(){b.init&&b.init.call(a)},f._plugins.constructor.forEach(function(c){c(a,b)})};return f._reserved=["init","listeners","defaultListener"],f.reserveKeyword=function(a){f._reserved.push(a)},f._plugins={constructor:[]},f.registerCeciPlugin=function(a,b){f._plugins[a].push(b)},f._defaultBroadcastChannel="blue",f._defaultListeningChannel="blue",f._emptyChannel="false",f._components={},f.convertElement=function(a){var b=f._components[a.localName],e=a.cloneNode(!0);a._innerHTML=a.innerHTML,a._innerText=a.innerText,b.template&&(a.innerHTML=b.template.innerHTML),b.contructor.call(a,b.initParams|{}),c(a,e),d(a,e),a.init()},f.processComponent=function(a){var b=a.getAttribute("name"),c=a.querySelector("template"),d=a.querySelector('script[type="text/ceci"]');try{var e=new Function("Ceci","return function() {"+d.innerHTML+"}")}catch(g){throw"SyntaxError"===g.name?(g.message+=' in definition of component "'+b+'".',g):g}var h=e(f);f._components[b]={template:c,contructor:h};var i=document.querySelectorAll(b);Array.prototype.forEach.call(i,function(a){f.convertElement(a)})},f.load=function(a){function b(a){var b=document.querySelectorAll("element");b=Array.prototype.slice.call(b),b.forEach(f.processComponent),a&&a(f._components)}var c=document.querySelectorAll('link[rel=component][type="text/ceci"]');if(c.length){var d=c.length;Array.prototype.forEach.call(c,function(c){var e=new XMLHttpRequest,f=c.getAttribute("href");e.open("GET",f,!0),e.onload=function(){var c=document.createElement("div");c.innerHTML=e.response,document.body.firstChild?document.body.insertBefore(c,document.body.firstChild):document.body.appendChild(c),0===--d&&b(a)},e.send(null)})}else b(a)},f});